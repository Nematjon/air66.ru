miniShop2.tree.Categories=function(config){config=config||{};Ext.applyIf(config,{url:miniShop2.config.connector_url,id:'minishop2-categories-tree',title:'',anchor:'100%',rootVisible:false,expandFirst:true,enableDD:false,ddGroup:'modx-treedrop-dd',remoteToolbar:false,action:'mgr/category/getnodes',tbarCfg:{id:config.id?config.id+'-tbar':'modx-tree-resource-tbar'},baseParams:{action:'mgr/category/getnodes',currentResource:MODx.request.id||0,currentAction:MODx.request.a||0},listeners:{checkchange:function(node,checked){this.mask.show();MODx.Ajax.request({url:miniShop2.config.connector_url,params:{action:'mgr/product/category',category_id:node.attributes.pk,product_id:MODx.request.id},listeners:{success:{fn:function(){this.mask.hide();},scope:this},failure:{fn:function(){this.mask.hide();},scope:this}}});},afterrender:function(){this.mask=new Ext.LoadMask(this.getEl());}}});miniShop2.tree.Categories.superclass.constructor.call(this,config);};Ext.extend(miniShop2.tree.Categories,MODx.tree.Tree,{_showContextMenu:function(n,e){n.select();this.cm.activeNode=n;this.cm.removeAll();var m=[];m.push({text:_('directory_refresh'),handler:function(){this.refreshNode(this.cm.activeNode.id,true);}});this.addContextMenuItem(m);this.cm.showAt(e.xy);e.stopEvent();}});Ext.reg('minishop2-tree-categories',miniShop2.tree.Categories);;miniShop2.panel.ProductGallery=function(config){config=config||{};Ext.apply(config,{border:false,id:'minishop2-product-gallery',baseCls:'modx-formpanel',listeners:{render:{fn:function(a){this.updateTabImage(config.record.thumb);},scope:this}},items:[{border:false,cls:'modx-page-header container',html:_('ms2_gallery_introtext')},{border:false,items:[{title:'',border:false,items:[{xtype:'minishop2-product-plupload-panel',id:'minishop2-product-plupload-panel',record:config.record,gridHeight:150,anchor:'50%'},{xtype:'minishop2-product-images-panel',id:'minishop2-product-images-panel',cls:'modx-pb-view-ct main-wrapper',product_id:config.record.id,anchor:'100%'}]}]}]});miniShop2.panel.ProductGallery.superclass.constructor.call(this,config);};Ext.extend(miniShop2.panel.ProductGallery,MODx.Panel,{updateTabImage:function(thumb){if(thumb===null||thumb==''||typeof(thumb)=='undefined'){thumb=miniShop2.config.logo_small;}
document.getElementById('minishop2-product-header-image').src=thumb;}});Ext.reg('minishop2-product-gallery',miniShop2.panel.ProductGallery);miniShop2.panel.ProductImages=function(config){config=config||{};this.view=MODx.load({id:'minishop2-product-images-view',xtype:'minishop2-product-images-view',onSelect:{fn:function(){},scope:this},containerScroll:true,ident:this.ident,cls:'minishop2-product-images',pageSize:config.pageSize||(Math.round(MODx.config.default_per_page/2)||10),product_id:config.product_id,inPanel:true,style:'overflow: auto;'});this.view.pagingBar=new Ext.PagingToolbar({pageSize:config.pageSize||(Math.round(MODx.config.default_per_page/2)||10),store:this.view.store,displayInfo:true,autoLoad:true,items:['-',_('per_page')+':',{xtype:'textfield',value:config.pageSize||(Math.round(MODx.config.default_per_page/2)||10),width:40,listeners:{change:{fn:function(tf,nv,ov){if(Ext.isEmpty(nv))return false;nv=parseInt(nv);this.view.pagingBar.pageSize=nv;this.view.store.load({params:{start:0,limit:nv}});},scope:this},render:{fn:function(cmp){new Ext.KeyMap(cmp.getEl(),{key:Ext.EventObject.ENTER,fn:function(){this.fireEvent('change',this.getValue());this.blur();return true;},scope:cmp});},scope:this}}},'-']});var dv=this.view;dv.on('render',function(){dv.dragZone=new MODx.DataView.dragZone(dv);dv.dropZone=new MODx.DataView.dropZone(dv);});Ext.applyIf(config,{id:'minishop2-product-images',cls:'browser-win',layout:'column',minWidth:500,minHeight:350,autoHeight:true,modal:false,closeAction:'hide',border:false,autoScroll:true,items:[{id:'minishop2-product-gallery-list',cls:'browser-view',region:'center',width:'50%',minHeight:450,autoScroll:true,border:false,tbar:[this.view.pagingBar],items:[this.view]},{html:'',id:'minishop2-product-gallery-details',region:'east',split:true,autoScroll:true,width:'45%',minWidth:150,maxWidth:250,height:450,border:false}]});miniShop2.panel.ProductImages.superclass.constructor.call(this,config);};Ext.extend(miniShop2.panel.ProductImages,MODx.Panel,{windows:{}});Ext.reg('minishop2-product-images-panel',miniShop2.panel.ProductImages);miniShop2.view.ProductImages=function(config){config=config||{};this._initTemplates();Ext.applyIf(config,{url:miniShop2.config.connector_url,fields:['id','product_id','name','description','url','createdon','createdby','file','thumbnail','filesort','source','type'],id:'minishop2-product-images-view',baseParams:{action:'mgr/gallery/getlist',product_id:config.product_id,parent:0,type:'image',limit:config.pageSize||10},loadingText:_('loading'),enableDD:true,multiSelect:true,tpl:this.templates.thumb,itemSelector:'div.modx-browser-thumb-wrap',listeners:{selectionchange:{fn:this.showDetails,scope:this,buffer:100},dblclick:config.onSelect||{fn:Ext.emptyFn,scope:this}},prepareData:this.formatData.createDelegate(this)});miniShop2.view.ProductImages.superclass.constructor.call(this,config);this.on('selectionchange',this.showDetails,this,{buffer:100});this.addEvents('sort','select');this.on('sort',this.onSort,this);this.on('dblclick',this.onDblClick,this);};Ext.extend(miniShop2.view.ProductImages,MODx.DataView,{templates:{},windows:{},onSort:function(o){MODx.Ajax.request({url:miniShop2.config.connector_url,params:{action:'mgr/gallery/sort',product_id:this.config.product_id,source:o.source.id,target:o.target.id},listeners:{success:{fn:function(response){Ext.getCmp('minishop2-product-gallery').updateTabImage(response.message);},scope:this}}});},onDblClick:function(d,idx,n){var node=this.getSelectedNodes()[0];if(!node)return false;if(this.config.inPanel){this.cm.activeNode=node;this.updateImage(node,n);}else{var data=this.lookup[node.id];this.fireEvent('select',data);}},updateImage:function(btn,e){var node=this.cm.activeNode;var data=this.lookup[node.id];if(!data)return false;this.windows.updateImage=MODx.load({xtype:'minishop2-gallery-image-update',record:data,listeners:{success:{fn:function(){this.store.reload();},scope:this}}});this.windows.updateImage.setValues(data);this.windows.updateImage.show(e.target);},deleteImage:function(btn,e){var node=this.cm.activeNode;var data=this.lookup[node.id];if(!data)return false;MODx.msg.confirm({text:_('ms2_gallery_file_delete_confirm'),url:this.config.url,params:{action:'mgr/gallery/remove',id:data.id},listeners:{success:{fn:function(response){Ext.getCmp('minishop2-product-gallery').updateTabImage(response.message);this.store.reload();},scope:this}}});},deleteMultiple:function(btn,e){var recs=this.getSelectedRecords();if(!recs)return false;var ids='';for(var i=0;i<recs.length;i++){ids+=','+recs[i].id;}
MODx.msg.confirm({text:_('ms2_gallery_file_delete_multiple_confirm'),url:this.config.url,params:{action:'mgr/gallery/remove_multiple',ids:ids.substr(1),product_id:this.config.product_id},listeners:{'success':{fn:function(response){Ext.getCmp('minishop2-product-gallery').updateTabImage(response.message);this.store.reload();},scope:this}}});return true;},generateThumbs:function(){var node=this.cm.activeNode;var data=this.lookup[node.id];if(!data)return false;MODx.Ajax.request({url:miniShop2.config.connector_url,params:{action:'mgr/gallery/generate',id:data.id},listeners:{success:{fn:function(response){this.store.reload()},scope:this}}});},generateThumbsMultiple:function(){var recs=this.getSelectedRecords();if(!recs)return false;var ids='';for(var i=0;i<recs.length;i++){ids+=','+recs[i].id;}
MODx.Ajax.request({url:miniShop2.config.connector_url,params:{action:'mgr/gallery/generate_multiple',ids:ids.substr(1)},listeners:{success:{fn:function(response){this.store.reload()},scope:this}}});},run:function(p){p=p||{};var v={};Ext.apply(v,this.store.baseParams);Ext.apply(v,p);this.pagingBar.changePage(1);this.store.baseParams=v;this.store.load();},showDetails:function(){var selNode=this.getSelectedNodes();var detailEl=Ext.getCmp('minishop2-product-gallery-details').body;if(selNode&&selNode.length>0){selNode=selNode[0];var data=this.lookup[selNode.id];if(data){this.templates.details.overwrite(detailEl,data);}}else{detailEl.update('');}},formatData:function(data){var formatSize=function(data){if(data.size<1024){return data.size+'B';}else{return(Math.round(((data.size*10)/1024))/10)+" KB";}};data.shortName=Ext.util.Format.ellipsis(data.name,16);data.createdon=miniShop2.utils.formatDate(data.createdon);this.lookup['ms2-product-image-'+data.id]=data;return data;},_initTemplates:function(){this.templates.thumb=new Ext.XTemplate('<tpl for=".">','<div class="modx-browser-thumb-wrap modx-pb-thumb-wrap" id="ms2-product-image-{id}">','<div class="modx-browser-thumb modx-gal-item-thumb">','<img src="{thumbnail}" title="{name}" />','</div>','<span>{shortName}</span>','</div>','</tpl>');this.templates.thumb.compile();this.templates.details=new Ext.XTemplate('<div class="details">','<tpl for=".">','<div class="modx-gallery-detail-thumb">','<tpl if="type == \'image\'">','<a href="{url}" target="_blank"><img src="{url}" alt="{name}" /></a>','</tpl>','<tpl if="type != \'image\'">','<a href="{url}" target="_blank"><img src="{thumbnail}" alt="{name}" /></a>','</tpl>','</div><div class="modx-gallery-details-info">',_('ms2_gallery_filename')+': <strong>{file}</strong><br/><br/>',_('ms2_gallery_title')+': <strong>{name}</strong><br/><br/>',_('ms2_gallery_createdon')+': <strong>{createdon}</strong><br/><br/>',_('ms2_product_source')+': <strong>{source}</strong><br/><br/>',_('ms2_gallery_url')+': <a href="{url}" target="_blank" class="link">{url}</a>','<tpl if="description"><p class="description">{description}</p></tpl>','</div>','</tpl>','</div>');this.templates.details.compile();},_showContextMenu:function(v,i,n,e){e.preventDefault();var data=this.lookup[n.id];var m=this.cm;m.removeAll();var ct=this.getSelectionCount();if(ct==1){m.add({text:_('ms2_gallery_file_update'),handler:this.updateImage,scope:this});if(data.type=='image'){m.add({text:_('ms2_gallery_image_generate_thumbs'),handler:this.generateThumbs,scope:this});}
m.add('-');m.add({text:_('ms2_gallery_file_delete'),handler:this.deleteImage,scope:this});m.show(n,'tl-c?');}else if(ct>1){if(data.type=='image'){m.add({text:_('ms2_gallery_image_generate_thumbs'),handler:this.generateThumbsMultiple,scope:this});}
m.add('-');m.add({text:_('ms2_gallery_file_delete_multiple'),handler:this.deleteMultiple,scope:this});m.show(n,'tl-c?');}
m.activeNode=n;}});Ext.reg('minishop2-product-images-view',miniShop2.view.ProductImages);miniShop2.window.UpdateImage=function(config){config=config||{};this.ident=config.ident||'gupdit'+Ext.id();Ext.applyIf(config,{title:config.record.shortName||_('ms2_gallery_file_update'),id:this.ident,closeAction:'close',width:450,autoHeight:true,url:miniShop2.config.connector_url,action:'mgr/gallery/update',layout:'anchor',fields:[{xtype:'hidden',name:'id',id:this.ident+'-id'},{xtype:'textfield',fieldLabel:_('ms2_gallery_filename'),name:'file',id:this.ident+'-file',anchor:'100%'},{xtype:'textfield',fieldLabel:_('ms2_gallery_title'),name:'name',id:this.ident+'-name',anchor:'100%'},{xtype:'textarea',fieldLabel:_('ms2_gallery_description'),name:'description',id:this.ident+'-description',anchor:'100% -120'}],keys:[{key:Ext.EventObject.ENTER,shift:true,fn:this.submit,scope:this}]});miniShop2.window.UpdateImage.superclass.constructor.call(this,config);};Ext.extend(miniShop2.window.UpdateImage,MODx.Window);Ext.reg('minishop2-gallery-image-update',miniShop2.window.UpdateImage);miniShop2.panel.Plupload=function(config){config=config||{};Ext.applyIf(config,{id:'ms2-plupload-panel',width:'100%',height:(config.gridHeight||200)+50,autoScroll:false,border:false,frame:false,cls:'',layout:'absolute',uploadListData:{},tbar:{width:'90%',items:[{xtype:'button',id:'ms2_gallery-upload-button-'+config.record.id,text:_('ms2_gallery_button_upload')},{xtype:'tbspacer',width:30},{xtype:'displayfield',html:'<b>'+_('ms2_product_source')+'</b>:&nbsp;&nbsp;'},{xtype:'minishop2-combo-source',id:'minishop2-product-source',description:'<b>[[+source]]</b><br />'+_('ms2_product_source_help'),value:config.record.source,listeners:{select:{fn:this.sourceWarning,scope:this}}},{xtype:'tbspacer',width:30},{xtype:'button',text:_('ms2_gallery_uploads_clear'),handler:function(){this.fileGrid.getStore().removeAll();this.resetUploader();},scope:this}]},items:[{xtype:'panel',width:'90%'},{xtype:'grid',id:'plupload-files-grid-'+config.record.id,width:'90%',height:config.gridHeight||200,enableHdMenu:false,store:new Ext.data.ArrayStore({fields:['id','name','size','status','progress'],reader:new Ext.data.ArrayReader({idIndex:0},this.fileRecord)}),autoExpandColumn:'plupload-column-filename',viewConfig:{forceFit:true,enableRowBody:true,autoFill:true,showPreview:true,scrollOffset:0,emptyText:_('ms2_gallery_emptymsg')},columns:[{header:_('ms2_gallery_filename'),dataIndex:'name',width:250,id:'plupload-column-filename'},{header:_('ms2_gallery_size'),dataIndex:'size',width:100,renderer:Ext.util.Format.fileSize},{header:_('ms2_gallery_status'),dataIndex:'status',width:100,renderer:this.statusRenderer},{header:_('ms2_gallery_progress'),dataIndex:'percent',width:200,scope:this,renderer:this.progressBarColumnRenderer}],listeners:{render:{fn:function(){this._initUploader();},scope:this},viewready:{fn:function(){this.fileGrid.getStore().removeAll();},scope:this}}}]});miniShop2.panel.Plupload.superclass.constructor.call(this,config);var fields=['id','name','size','status','progress'];this.fileRecord=Ext.data.Record.create(fields);this.fileGrid=Ext.getCmp('plupload-files-grid-'+this.record.id);};Ext.extend(miniShop2.panel.Plupload,MODx.Panel,{sourceWarning:function(combo,option){var source=Ext.getCmp('modx-resource-source-hidden');var select=Ext.getCmp('minishop2-product-source');var source_id=source.getValue();var sel_id=select.getValue();if(source_id!=sel_id){Ext.Msg.confirm(_('warning'),_('ms2_product_change_source_confirm'),function(e){if(e=='yes'){source.setValue(sel_id);var f=Ext.getCmp('modx-page-update-resource');MODx.activePage.submitForm({success:{fn:function(r){var page=MODx.action?MODx.action['resource/update']:'resource/update';MODx.loadPage(page,'id='+r.result.object.id);},scope:this}});}else{select.setValue(source_id);}},this);}},progressBarColumnTemplate:new Ext.XTemplate('<div class="ux-progress-cell-inner ux-progress-cell-inner-center ux-progress-cell-foreground">','<div>{value} %</div>','</div>','<div class="ux-progress-cell-inner ux-progress-cell-inner-center ux-progress-cell-background" style="left:{value}%">','<div style="left:-{value}%">{value} %</div>','</div>'),progressBarColumnRenderer:function(value,meta,record,rowIndex,colIndex,store){meta.css+=' x-grid3-td-progress-cell';return this.progressBarColumnTemplate.apply({value:value});},statusRenderer:function(value,meta,record,rowIndex,colIndex,store){return _('ms2_gallery_status_code_'+value);},updateFile:function(file){var store=this.fileGrid.getStore();var storeId=store.find('id',file.id);var fileRec=store.getAt(storeId);fileRec.set('percent',file.percent);fileRec.set('status',file.status);fileRec.set('size',file.size);fileRec.commit();},uploader:null,_initUploader:function(){var params={action:'mgr/gallery/upload',id:this.record.id,source:this.record.source,ctx:'mgr',HTTP_MODAUTH:MODx.siteId};this.uploader=new plupload.Uploader({url:miniShop2.config.connector_url+'?'+Ext.urlEncode(params),runtimes:'html5,flash,html4',browse_button:'ms2_gallery-upload-button-'+this.record.id,container:this.id,drop_element:'plupload-files-grid-'+this.record.id,multipart:false,max_file_size:miniShop2.config.media_source.maxUploadSize||10485760,flash_swf_url:miniShop2.config.assets_url+'js/mgr/misc/plupload/plupload.flash.swf',filters:[{title:"Image files",extensions:miniShop2.config.media_source.allowedFileTypes||'jpg,jpeg,png,gif'}],resize:{width:miniShop2.config.media_source.maxUploadWidth||1920,height:miniShop2.config.media_source.maxUploadHeight||1080}});var uploaderEvents=['FilesAdded','FileUploaded','QueueChanged','UploadFile','UploadProgress','UploadComplete'];Ext.each(uploaderEvents,function(v){var fn='on'+v;this.uploader.bind(v,this[fn],this);},this);this.uploader.init();},onFilesAdded:function(up,files){this.uploadListData.files=up.files;this.updateList=true;},removeFile:function(id){this.updateList=true;var f=this.uploader.getFile(id);this.uploader.removeFile(f);},onQueueChanged:function(up){if(this.updateList){if(this.uploadListData.files.length>0){var ms2g=this;Ext.each(this.uploadListData.files,function(file,i){var fileRec=new ms2g.fileRecord(file);ms2g.fileGrid.store.add(fileRec);});ms2g.uploader.start();}else{var store=this.fileGrid.getStore();store.removeAll();}
up.refresh();}},onUploadFile:function(uploader,file){this.updateFile(file);},onUploadProgress:function(uploader,file){this.updateFile(file);},onUploadComplete:function(uploader,files){if(this.errors.length>0){this.fireAlert();}
Ext.getCmp('minishop2-product-images-panel').view.getStore().reload();MODx.Ajax.request({url:miniShop2.config.connector_url,params:{action:'mgr/product/get',id:this.record.id},listeners:{success:{fn:function(response){Ext.getCmp('minishop2-product-gallery').updateTabImage(response.object.thumb);},scope:this}}});this.resetUploader();},onFileUploaded:function(uploader,file,xhr){var r=Ext.util.JSON.decode(xhr.response);if(!r.success){this.addError(file.name,r.message);}
this.updateFile(file);},resetUploader:function(){this.uploader.destroy();this.uploadListData.files={};this.errors='';this._initUploader();},errors:'',addError:function(file,message){this.errors+=file+': '+message+'<br/>';},fireAlert:function(){MODx.msg.alert(_('ms2_gallery_errors'),this.errors);}});Ext.reg('minishop2-product-plupload-panel',miniShop2.panel.Plupload);;miniShop2.grid.ProductLinks=function(config){config=config||{};this.exp=new Ext.grid.RowExpander({expandOnDblClick:false,tpl:new Ext.Template('<p class="desc">{description}</p>'),renderer:function(v,p,record){return record.data.description!=''&&record.data.description!=null?'<div class="x-grid3-row-expander">&#160;</div>':'&#160;';}});Ext.applyIf(config,{id:'minishop2-grid-product-link',url:miniShop2.config.connector_url,baseParams:{action:'mgr/product/productlink/getlist',master:config.record.id},fields:['id','link','type','name','master','slave','master_pagetitle','slave_pagetitle','description'],autoHeight:true,paging:true,remoteSort:true,plugins:this.exp,columns:[this.exp,{header:_('ms2_link_name'),dataIndex:'name',width:75,sortable:true},{header:_('ms2_type'),dataIndex:'type',width:75,sortable:true,renderer:this.renderType},{header:_('ms2_link_master'),dataIndex:'master_pagetitle',width:125,sortable:true,renderer:this.renderMaster},{header:_('ms2_link_slave'),dataIndex:'slave_pagetitle',width:125,sortable:true,renderer:this.renderSlave}],tbar:[{text:_('ms2_btn_create'),handler:this.createProductLink,scope:this}]});miniShop2.grid.ProductLinks.superclass.constructor.call(this,config);};Ext.extend(miniShop2.grid.ProductLinks,MODx.grid.Grid,{getMenu:function(){var m=[];m.push({text:_('ms2_menu_remove'),handler:this.removeProductLink});this.addContextMenuItem(m);},renderType:function(value){return _('ms2_link_'+value);},renderMaster:function(value,cell,row){if(row.data.master==MODx.request.id){return value;}
else{row.data['product_id']=row.data.master;return miniShop2.utils.productLink(value,cell,row);}},renderSlave:function(value,cell,row){if(row.data.slave==MODx.request.id){return value;}
else{row.data['product_id']=row.data.slave;return miniShop2.utils.productLink(value,cell,row);}},createProductLink:function(btn,e){if(!this.windows.createProductLink){this.windows.createProductLink=MODx.load({xtype:'minishop2-window-product-link-create',title:_('ms2_btn_create'),fields:this.getProductLinkFields('create'),baseParams:{action:'mgr/product/productlink/create',master:btn.scope.record.id},listeners:{success:{fn:function(){this.refresh();},scope:this}}});}
Ext.getCmp('minishop2-link-slave-create').reset();this.windows.createProductLink.show(e.target);},removeProductLink:function(btn,e){if(this.menu.record){MODx.msg.confirm({title:_('ms2_menu_remove'),text:_('ms2_menu_remove_confirm'),url:miniShop2.config.connector_url,params:{action:'mgr/product/productlink/remove',link:this.menu.record.link,master:this.menu.record.master,slave:this.menu.record.slave},listeners:{success:{fn:function(r){this.refresh();},scope:this}}});}},getProductLinkFields:function(type){return[{xtype:'minishop2-combo-link',fieldLabel:_('ms2_link'),name:'link',allowBlank:false,anchor:'99%',id:'minishop2-link-name-'+type},{xtype:'minishop2-combo-product',fieldLabel:_('ms2_product'),name:'slave',hiddenName:'slave',allowBlank:false,anchor:'99%',id:'minishop2-link-slave-'+type}];}});Ext.reg('minishop2-product-links-grid',miniShop2.grid.ProductLinks);miniShop2.window.CreateProductLink=function(config){config=config||{};this.ident=config.ident||'meuitem'+Ext.id();Ext.applyIf(config,{title:_('ms2_menu_update'),id:this.ident,width:600,autoHeight:true,labelAlign:'left',labelWidth:180,url:miniShop2.config.connector_url,action:'mgr/product/productlink/create',fields:config.fields,keys:[{key:Ext.EventObject.ENTER,shift:true,fn:function(){this.submit()},scope:this}]});miniShop2.window.CreateProductLink.superclass.constructor.call(this,config);};Ext.extend(miniShop2.window.CreateProductLink,MODx.Window);Ext.reg('minishop2-window-product-link-create',miniShop2.window.CreateProductLink);;var methods={getMainFields:function(config){config=config||{record:{}};return[{layout:'column',border:false,anchor:'100%',id:'modx-resource-main-columns',defaults:{labelSeparator:'',labelAlign:'top',border:false,msgTarget:'under'},items:[{columnWidth:.70,layout:'form',id:'modx-resource-main-left',defaults:{msgTarget:'under'},items:this.getMainLeftFields(config)},{columnWidth:.30,layout:'form',labelWidth:0,border:false,id:'modx-resource-main-right',style:'margin-right: 0',defaults:{msgTarget:'under'},items:this.getMainRightFields(config)}]},{html:MODx.onDocFormRender,border:false},{xtype:'hidden',name:'id',id:'modx-resource-id',value:config.record.id,submitValue:true},{xtype:'hidden',name:'type',value:'document'},{xtype:'hidden',name:'context_key',id:'modx-resource-context-key',value:config.record.context_key||'web'},{xtype:'hidden',name:'content_type',id:'modx-resource-content-type',value:MODx.config.default_content_type||1},{xtype:'hidden',name:'class_key',id:'modx-resource-class-key',value:'msProduct'},{xtype:'hidden',name:'content',id:'hiddenContent',value:(config.record.content||config.record.ta)||''},{xtype:'hidden',name:'create-resource-token',id:'modx-create-resource-token',value:config.record.create_resource_token||''},{xtype:'hidden',name:'reloaded',value:!Ext.isEmpty(MODx.request.reload)?1:0},{xtype:'hidden',name:'parent',value:config.record.parent||0,id:'modx-resource-parent-hidden'},{xtype:'hidden',name:'isfolder',value:0,id:'modx-resource-isfolder-hidden'},{xtype:'hidden',name:'parent-original',value:config.record.parent||0,id:'modx-resource-parent-old-hidden'},{xtype:'hidden',name:'source',value:config.record.source||1,id:'modx-resource-source-hidden'}];},getMainLeftFields:function(config){config=config||{record:{}};var fields=[];var enabled=['pagetitle','longtitle','introtext','description'];var items=fields.push(this.getProductFields(config,enabled,miniShop2.config.main_fields));enabled=miniShop2.config.data_fields;var tmp=this.getProductFields(config,enabled,miniShop2.config.main_fields);var middle=Math.ceil(tmp.length/2)-1;if(tmp.length>0){var array={layout:'column',xtype:'fieldset',title:_('ms2_product'),border:false,defaults:{border:false},items:[{columnWidth:.5,layout:'form',items:[]},{columnWidth:.5,layout:'form',items:[]}]};for(var i=0;i<tmp.length;i++){var field=tmp[i];field.anchor='100%';if(i>middle){array.items[1].items.push(field);}
else{array.items[0].items.push(field);}}
fields.push(array);}
enabled=['content'];fields.push(this.getProductFields(config,enabled,miniShop2.config.main_fields));return fields;},getMainRightFields:function(config){config=config||{};var enabled,items;var fields=[];enabled=['createdby','publishedby','deletedby','publishedon','pub_date','unpub_date','createdon','deletedon'];items=this.getProductFields(config,enabled,miniShop2.config.main_fields);if(items.length>0){fields.push({xtype:'fieldset',id:'minishop2-box-dates',items:items});}
enabled=['parent','template','alias','menutitle','menuindex','link_attributes'];items=this.getProductFields(config,enabled,miniShop2.config.main_fields);if(items.length>0){fields.push({xtype:'fieldset',id:'minishop2-box-template',items:items});}
enabled=['searchable','cacheable','richtext','syncsite','uri_override','hidemenu','show_in_tree','new','favorite','popular'];items=this.getProductFields(config,enabled,miniShop2.config.main_fields);items.push({xtype:'xcheckbox',name:'deleted',inputValue:1,id:'modx-resource-deleted',boxLabel:_('ms2_product_deleted'),description:'<b>[[*deleted]]</b><br/>'+_('resource_deleted_help'),checked:parseInt(config.record.deleted),hidden:config.mode=='update'?1:0});items.push({xtype:'xcheckbox',name:'published',inputValue:1,id:'modx-resource-published',boxLabel:_('ms2_product_published'),description:'<b>[[*published]]</b><br/>'+_('resource_published_help'),checked:parseInt(config.record.published),hidden:config.mode=='update'?1:0});if(items.length>0){fields.push({xtype:'checkboxgroup',columns:2,id:'minishop2-box-options',items:items});fields.push({xtype:'textfield',name:'uri',id:'modx-resource-uri',fieldLabel:_('ms2_product_uri'),value:config.record.uri||'',hidden:!config.record.uri_override,anchor:'100%'});}
return fields;},getDataFields:function(config){config=config||{record:{}};return[{layout:'column',border:false,anchor:'100%',id:'modx-resource-extra-columns',defaults:{labelSeparator:'',labelAlign:'top',border:false,msgTarget:'under'},items:[{columnWidth:.5,layout:'form',id:'minishop2-product-extra-left',items:this.getExtraFields(config)},{columnWidth:.5,title:_('ms2_category_tree'),id:'minishop2-product-extra-right',style:'margin-top: 12px;',items:[{xtype:config.mode=='create'?'displayfield':'minishop2-tree-categories',value:_('ms2_disabled_while_creating'),record:config.record}]}]}];},getExtraFields:function(config){config=config||{record:{}};var enabled=miniShop2.config.data_fields;var items=this.getProductFields(config,enabled,miniShop2.config.extra_fields);if(items.length>0){return{xtype:'fieldset',items:items};}
else{return[];}},getProductFields:function(config,enabled,available){var product_fields=this.getAllProductFields(config);var fields=[];var tmp,properties;for(var i=0;i<available.length;i++){var field=available[i];if((enabled.length>0&&enabled.indexOf(field)===-1)||miniShop2.config.active_fields.indexOf(field)!==-1){continue;}
if(tmp=product_fields[field]){miniShop2.config.active_fields.push(field);properties={description:'<b>[[*'+field+']]</b><br />'+_('resource_'+field+'_help'),enableKeyEvents:true,listeners:config.listeners,name:field,id:'modx-resource-'+field,value:config.record[field]||'',msgTarget:'under'};if(tmp.allowBlank===false){tmp.fieldLabel=tmp.fieldLabel+' <span class="required red">*</span>'}
switch(tmp.xtype){case'minishop2-xdatetime':case'minishop2-combo-user':properties.anchor='95%';properties.fieldLabel=_('ms2_product_'+field);break;case'xcheckbox':properties.boxLabel=_('ms2_product_'+field);break;case'textfield':properties.maxLength=255;default:properties.fieldLabel=_('ms2_product_'+field);properties.anchor='100%';}
Ext.applyIf(tmp,properties);fields.push(tmp);}}
return fields;},getAllProductFields:function(config){var fields={pagetitle:{xtype:'textfield',fieldLabel:_('ms2_product_pagetitle'),maxLength:255,allowBlank:false,listeners:{'keyup':{scope:this,fn:function(f,e){var title=Ext.util.Format.stripTags(f.getValue());Ext.getCmp('modx-resource-header').getEl().update('<h2>'+title+'</h2>');MODx.fireResourceFormChange();}}}},longtitle:{xtype:'textfield'},description:{xtype:'textarea'},introtext:{xtype:'textarea',description:'<b>[[*introtext]]</b><br />'+_('resource_summary_help')},content:{xtype:'textarea',name:'ta',id:'ta',description:'',height:400,grow:false,value:(config.record.content||config.record.ta)||''},createdby:{xtype:'minishop2-combo-user',value:config.record.createdby,description:'<b>[[*createdby]]</b><br/>'+_('ms2_product_createdby_help')},publishedby:{xtype:'minishop2-combo-user',value:config.record.publishedby,description:'<b>[[*publishedby]]</b><br/>'+_('ms2_product_publishedby_help')},deletedby:{xtype:'minishop2-combo-user',value:config.record.deletedby,description:'<b>[[*deletedby]]</b><br/>'+_('ms2_product_deletedby_help')},editedby:{xtype:'minishop2-combo-user',value:config.record.deletedby,description:'<b>[[*editedby]]</b><br/>'+_('ms2_product_editedby_help')},publishedon:{xtype:'minishop2-xdatetime',value:config.record.publishedon,description:'<b>[[*publishedon]]</b><br/>'+_('ms2_product_publishedon_help')},createdon:{xtype:'minishop2-xdatetime',value:config.record.createdon,description:'<b>[[*createdon]]</b><br/>'+_('ms2_product_createdon_help')},deletedon:{xtype:'minishop2-xdatetime',value:config.record.deletedon,description:'<b>[[*deletedon]]</b><br/>'+_('ms2_product_deletedon_help')},editedon:{xtype:'minishop2-xdatetime',value:config.record.editedon,description:'<b>[[*editedon]]</b><br/>'+_('ms2_product_editedon_help')},pub_date:{xtype:MODx.config.publish_document?'minishop2-xdatetime':'hidden',description:'<b>[[*pub_date]]</b><br />'+_('resource_publishdate_help'),id:'modx-resource-pub-date',value:config.record.pub_date},unpub_date:{xtype:MODx.config.publish_document?'minishop2-xdatetime':'hidden',description:'<b>[[*unpub_date]]</b><br />'+_('resource_unpublishdate_help'),id:'modx-resource-unpub-date',value:config.record.unpub_date},template:{xtype:'modx-combo-template',editable:false,baseParams:{action:MODx.modx23?'element/template/getlist':'getlist',combo:'1'},listeners:{select:{fn:this.templateWarning,scope:this}}},parent:{xtype:'minishop2-combo-category',value:config.record.parent,listeners:{select:{fn:function(data){Ext.getCmp('modx-resource-parent-hidden').setValue(data.value);MODx.fireResourceFormChange();}}}},alias:{xtype:'textfield',value:config.record.alias||''},menutitle:{xtype:'textfield',value:config.record.menutitle||''},menuindex:{xtype:'numberfield',value:config.record.menuindex||0,anchor:'50%'},link_attributes:{xtype:'textfield',value:config.record.link_attributes||'',id:'modx-resource-link-attributes'},searchable:{xtype:'xcheckbox',inputValue:1,checked:parseInt(config.record.searchable)},cacheable:{xtype:'xcheckbox',inputValue:1,checked:parseInt(config.record.cacheable)},richtext:{xtype:'xcheckbox',inputValue:1,checked:parseInt(config.record.richtext)},hidemenu:{xtype:'xcheckbox',inputValue:1,checked:parseInt(config.record.hidemenu),description:'<b>[[*hidemenu]]</b><br/>'+_('resource_hide_from_menus_help')},uri_override:{xtype:'xcheckbox',inputValue:1,checked:parseInt(config.record.uri_override),id:'modx-resource-uri-override'},syncsite:{xtype:'xcheckbox',inputValue:1,description:_('resource_syncsite_help'),checked:config.record.syncsite!==undefined&&config.record.syncsite!==null?parseInt(config.record.syncsite):true},show_in_tree:{xtype:'xcheckbox',inputValue:1,description:'<b>[[*show_in_tree]]</b><br/>'+_('ms2_product_show_in_tree_help'),checked:parseInt(config.record.show_in_tree)},article:{xtype:'textfield',description:'<b>[[+article]]</b><br />'+_('ms2_product_article_help')},price:{xtype:'numberfield',decimalPrecision:2,description:'<b>[[+price]]</b><br />'+_('ms2_product_price_help')},old_price:{xtype:'numberfield',decimalPrecision:2,description:'<b>[[+old_price]]</b><br />'+_('ms2_product_old_price_help')},weight:{xtype:'numberfield',decimalPrecision:3,description:'<b>[[+weight]]</b><br />'+_('ms2_product_weight_help')},remains:{xtype:'numberfield',description:'<b>[[+remains]]</b><br />'+_('ms2_product_remains_help')},reserved:{xtype:'numberfield',description:'<b>[[+reserved]]</b><br />'+_('ms2_product_reserved_help')},vendor:{xtype:'minishop2-combo-vendor',description:'<b>[[+vendor]]</b><br />'+_('ms2_product_vendor_help')},made_in:{xtype:'minishop2-combo-autocomplete',description:'<b>[[+made_in]]</b><br />'+_('ms2_product_made_in_help')},source:{xtype:config.mode=='update'?'hidden':'minishop2-combo-source',name:'source-cmb',disabled:config.mode=='update',value:config.record.source||1,description:'<b>[[+source]]</b><br />'+_('ms2_product_source_help'),listeners:{select:{fn:function(data){Ext.getCmp('modx-resource-source-hidden').setValue(data.value);MODx.fireResourceFormChange();}}}},new:{xtype:'xcheckbox',inputValue:1,checked:parseInt(config.record.new),description:'<b>[[+new]]</b><br />'+_('ms2_product_new_help')},favorite:{xtype:'xcheckbox',inputValue:1,checked:parseInt(config.record.favorite),description:'<b>[[+favorite]]</b><br />'+_('ms2_product_favorite_help')},popular:{xtype:'xcheckbox',inputValue:1,checked:parseInt(config.record.popular),description:'<b>[[+popular]]</b><br />'+_('ms2_product_popular_help')},tags:{xtype:'minishop2-combo-options',description:_('ms2_product_tags_help')},color:{xtype:'minishop2-combo-options',description:_('ms2_product_color_help')},size:{xtype:'minishop2-combo-options',description:_('ms2_product_size_help')}};for(var i in miniShop2.plugin){if(typeof(miniShop2.plugin[i]['getFields'])=='function'){var add=miniShop2.plugin[i].getFields(config);Ext.apply(fields,add);}}
return fields;},templateWarning:function(){var t=Ext.getCmp('modx-resource-template');if(!t){return false;}
if(t.getValue()!==t.originalValue){Ext.Msg.confirm(_('warning'),_('resource_change_template_confirm'),function(e){if(e=='yes'){var nt=t.getValue();var f=Ext.getCmp('modx-page-update-resource');f.config.action=MODx.modx23?'resource/reload':'reload';MODx.activePage.submitForm({success:{fn:function(r){var page=MODx.action?MODx.action[r.result.object.action]:r.result.object.action;MODx.loadPage(page,'id='+r.result.object.id+'&reload='+r.result.object.reload+'&class_key='+this.config.record.class_key);},scope:this}},{bypassValidCheck:true},{reloadOnly:true});}else{t.setValue(this.config.record.template);}},this);}
return true;},getGallery:function(config){return{xtype:config.mode=='create'?'displayfield':'minishop2-product-gallery',value:_('ms2_disabled_while_creating'),record:config.record};},getLinks:function(config){return{xtype:config.mode=='create'?'displayfield':'minishop2-product-links-grid',value:_('ms2_disabled_while_creating'),record:config.record};}};miniShop2.panel.ProductSettings=function(config){config=config||{};config.listeners={change:{fn:MODx.fireResourceFormChange},select:{fn:MODx.fireResourceFormChange},keydown:{fn:MODx.fireResourceFormChange},check:{fn:MODx.fireResourceFormChange},uncheck:{fn:MODx.fireResourceFormChange}};miniShop2.config.active_fields=[];var items=[{title:_('ms2_product_tab_main'),hideMode:'offsets',anchor:'100%',items:this.getMainFields(config),listeners:config.listeners}];if(miniShop2.config.product_tab_extra){items.push({title:_('ms2_product_tab_extra'),hideMode:'offsets',anchor:'100%',items:this.getDataFields(config),listeners:config.listeners});}
if(miniShop2.config.product_tab_gallery){items.push({title:_('ms2_product_tab_gallery'),hideMode:'offsets',anchor:'100%',items:this.getGallery(config)});}
if(miniShop2.config.product_tab_links){items.push({title:_('ms2_product_tab_links'),hideMode:'offsets',anchor:'100%',items:this.getLinks(config)});}
Ext.applyIf(config,{id:'minishop2-product-settings-panel',border:false,deferredRender:false,forceLayout:true,anchor:'97%',stateful:MODx.config.ms2_product_remember_tabs==true,stateEvents:['tabchange'],getState:function(){return{activeTab:this.items.indexOf(this.getActiveTab())};},headerCfg:{tag:'div',cls:'x-tab-panel-header vertical-tabs-header',id:'modx-resource-vtabs-header',html:'<img src="'+miniShop2.config.logo_small+'" width="120" height="90" id="minishop2-product-header-image" />'},items:items});miniShop2.panel.ProductSettings.superclass.constructor.call(this,config);};Ext.extend(miniShop2.panel.ProductSettings,MODx.VerticalTabs,methods);Ext.reg('minishop2-product-settings',miniShop2.panel.ProductSettings);miniShop2.panel.ProductSettingsHorizontal=function(config){config=config||{};config.listeners={change:{fn:MODx.fireResourceFormChange},select:{fn:MODx.fireResourceFormChange},keydown:{fn:MODx.fireResourceFormChange},check:{fn:MODx.fireResourceFormChange},uncheck:{fn:MODx.fireResourceFormChange}};miniShop2.config.active_fields=[];var items=[{title:_('ms2_product_tab_main'),hideMode:'offsets',anchor:'100%',items:this.getMainFields(config),listeners:config.listeners}];if(miniShop2.config.product_tab_extra){items.push({title:_('ms2_product_tab_extra'),hideMode:'offsets',anchor:'100%',items:this.getDataFields(config),listeners:config.listeners});}
if(miniShop2.config.product_tab_gallery){items.push({title:_('ms2_product_tab_gallery'),hideMode:'offsets',anchor:'100%',items:this.getGallery(config)});}
if(miniShop2.config.product_tab_links){items.push({title:_('ms2_product_tab_links'),hideMode:'offsets',anchor:'100%',items:this.getLinks(config)});}
Ext.applyIf(config,{id:'minishop2-product-settings-panel-horizontal',border:false,footerCfg:{tag:'div',cls:'x-tab-panel-footer tabs-footer',id:'modx-resource-htabs-footer',html:'<img src="'+miniShop2.config.logo_small+'" width="120" height="90" id="minishop2-product-header-image" />'},items:[{html:'',border:false,bodyCssClass:'panel-desc',bodyStyle:'margin-bottom: 10px'},{style:'padding: 5px;',xtype:'modx-tabs',defaults:{border:false,autoHeight:true},border:true,bodyCssClass:'tab-panel-wrapper main-wrapper',deferredRender:false,forceLayout:true,anchor:'97%',stateful:MODx.config.ms2_product_remember_tabs==true,stateEvents:['tabchange'],getState:function(){return{activeTab:this.items.indexOf(this.getActiveTab())};},items:items}]});miniShop2.panel.ProductSettingsHorizontal.superclass.constructor.call(this,config);};Ext.extend(miniShop2.panel.ProductSettingsHorizontal,MODx.Panel,methods);Ext.reg('minishop2-product-settings-horizontal',miniShop2.panel.ProductSettingsHorizontal);miniShop2.panel.ProductSettingsSimple=function(config){config=config||{};config.listeners={change:{fn:MODx.fireResourceFormChange},select:{fn:MODx.fireResourceFormChange},keydown:{fn:MODx.fireResourceFormChange},check:{fn:MODx.fireResourceFormChange},uncheck:{fn:MODx.fireResourceFormChange}};miniShop2.config.active_fields=[];Ext.applyIf(config,{id:'minishop2-product-settings-panel-simple',border:false,items:[{hideMode:'offsets',border:false,cls:'modx-resource-tab',layout:'form',labelAlign:'top',labelSeparator:'',bodyCssClass:'tab-panel-wrapper main-wrapper',autoHeight:true,defaults:{border:false,msgTarget:'under'},items:this.getMainFields(config),listeners:config.listeners}]});miniShop2.panel.ProductSettingsHorizontal.superclass.constructor.call(this,config);};Ext.extend(miniShop2.panel.ProductSettingsSimple,MODx.Panel,methods);Ext.reg('minishop2-product-settings-simple',miniShop2.panel.ProductSettingsSimple);;miniShop2.page.UpdateProduct=function(config){config=config||{record:{}};config.record=config.record||{};Ext.applyIf(config,{panelXType:'minishop2-panel-product'});miniShop2.page.UpdateProduct.superclass.constructor.call(this,config);};Ext.extend(miniShop2.page.UpdateProduct,MODx.page.UpdateResource,{getButtons:function(cfg){var btns=[];if(cfg.canSave==1){btns.push({process:MODx.modx23?'resource/update':'update',text:'<i class="'+(MODx.modx23?'icon icon-check':'bicon-ok')+'"></i> '+_('ms2_btn_save'),method:'remote',checkDirty:cfg.richtext||MODx.request.activeSave==1?false:true,cls:'primary-button',keys:[{key:MODx.config.keymap_save||'s',ctrl:true}]});btns.push('-');}else if(cfg.locked){btns.push({text:cfg.lockedText||_('locked'),handler:Ext.emptyFn,disabled:true});btns.push('-');}
btns.push({text:'<i class="'+(MODx.modx23?'icon icon-power-off':'bicon-off')+'"></i> '+_('ms2_btn_publish'),id:'minishop2-panel-btn-publish',handler:this.publishProduct,hidden:!cfg.canPublish||cfg.record.published,disabled:cfg.locked,scope:this,cls:'btn-orange'});btns.push({text:'<i class="'+(MODx.modx23?'icon icon-power-off':'bicon-off')+'"></i> '+_('ms2_btn_unpublish'),id:'minishop2-panel-btn-unpublish',handler:this.unpublishProduct,hidden:!cfg.canPublish||!cfg.record.published,disabled:cfg.locked,scope:this});btns.push('-');btns.push({text:'<i class="'+(MODx.modx23?'icon icon-trash-o':'bicon-trash')+'"></i> '+_('ms2_btn_delete'),id:'minishop2-panel-btn-delete',handler:this.deleteProduct,hidden:!cfg.canDelete||cfg.record.deleted,disabled:cfg.locked,scope:this,cls:'btn-brown'});btns.push({text:'<i class="'+(MODx.modx23?'icon icon-trash-o':'bicon-trash')+'"></i> '+_('ms2_btn_undelete'),id:'minishop2-panel-btn-undelete',handler:this.undeleteProduct,hidden:!cfg.canDelete||!cfg.record.deleted,disabled:cfg.locked,scope:this,cls:'btn-green'});btns.push('-');btns.push({text:'<i class="'+(MODx.modx23?'icon icon-eye':'bicon-eye-open')+'"></i> '+_('ms2_btn_view'),handler:this.preview,scope:this});btns.push('-');btns.push({text:'<i class="'+(MODx.modx23?'icon icon-copy':'bicon-file')+'"></i>',handler:this.duplicateProduct,scope:this,hidden:!cfg.canSave,tooltip:_('ms2_btn_duplicate')});btns.push('-');btns.push({text:'<i class="'+(MODx.modx23?'icon icon-arrow-left':'bicon-arrow-left')+'"></i>',handler:this.prevPage,disabled:!cfg.prev_page?1:0,scope:this,tooltip:_('ms2_btn_prev'),keys:[{key:37,alt:true,scope:this,fn:this.prevPage}]});btns.push({text:'<i class="'+(MODx.modx23?'icon icon-arrow-up':'bicon-arrow-up')+'"></i>',handler:this.upPage,scope:this,tooltip:_('ms2_btn_back'),keys:[{key:38,alt:true,scope:this,fn:this.upPage}]});btns.push({text:'<i class="'+(MODx.modx23?'icon icon-arrow-right':'bicon-arrow-right')+'"></i>',handler:this.nextPage,disabled:!cfg.next_page?1:0,scope:this,tooltip:_('ms2_btn_next'),keys:[{key:39,alt:true,scope:this,fn:this.nextPage}]});return btns;},publishProduct:function(btn,e){MODx.Ajax.request({url:miniShop2.config.connector_url,params:{action:'mgr/product/publish',id:this.record.id},listeners:{'success':{fn:function(r){var bp=Ext.getCmp('minishop2-panel-btn-publish');if(bp){bp.hide();}
var bu=Ext.getCmp('minishop2-panel-btn-unpublish');if(bu){bu.show();}
var p=Ext.getCmp('modx-resource-published');if(p){p.setValue(1);}
var po=Ext.getCmp('modx-resource-publishedon');if(po){po.setValue(r.object.publishedon);}
var pb=Ext.getCmp('modx-resource-publishedby');if(pb){pb.setValue(r.object.publishedby);}
this.refreshNode();},scope:this}}});},unpublishProduct:function(btn,e){MODx.Ajax.request({url:miniShop2.config.connector_url,params:{action:'mgr/product/unpublish',id:this.record.id},listeners:{'success':{fn:function(r){var bp=Ext.getCmp('minishop2-panel-btn-publish');if(bp){bp.show();}
var bu=Ext.getCmp('minishop2-panel-btn-unpublish');if(bu){bu.hide();}
var p=Ext.getCmp('modx-resource-published');if(p){p.setValue(0);}
var po=Ext.getCmp('modx-resource-publishedon');if(po){po.setValue('');}
var pb=Ext.getCmp('modx-resource-publishedby');if(pb){pb.setValue(0);}
this.refreshNode();},scope:this}}});},deleteProduct:function(btn,e){MODx.Ajax.request({url:miniShop2.config.connector_url,params:{action:'mgr/product/delete',id:this.record.id},listeners:{success:{fn:function(r){var bd=Ext.getCmp('minishop2-panel-btn-delete');if(bd){bd.hide();}
var bu=Ext.getCmp('minishop2-panel-btn-undelete');if(bu){bu.show();}
var d=Ext.getCmp('modx-resource-deleted');if(d){d.setValue(1);}
var dd=Ext.getCmp('modx-resource-deletedon');if(dd){dd.setValue(r.object.deletedon);}
var db=Ext.getCmp('modx-resource-deletedby');if(db){db.setValue(r.object.deletedby);}
this.refreshNode();},scope:this}}});},undeleteProduct:function(btn,e){MODx.Ajax.request({url:miniShop2.config.connector_url,params:{action:'mgr/product/undelete',id:this.record.id},listeners:{success:{fn:function(r){var bd=Ext.getCmp('minishop2-panel-btn-delete');if(bd){bd.show();}
bu=Ext.getCmp('minishop2-panel-btn-undelete').show();if(bu){bu.hide();}
var d=Ext.getCmp('modx-resource-deleted');if(d){d.setValue(0);}
var dd=Ext.getCmp('modx-resource-deletedon');if(dd){dd.setValue('');}
var db=Ext.getCmp('modx-resource-deletedby');if(db){db.setValue(0);}
this.refreshNode();},scope:this}}});},duplicateProduct:function(btn,e){MODx.msg.confirm({url:MODx.modx23?MODx.config.connector_url:MODx.config.connectors_url+'resource/index.php',text:_('ms2_product_duplicate_confirm'),params:{action:MODx.modx23?'resource/duplicate':'duplicate',id:this.record.id},listeners:{success:{fn:function(response){var page=MODx.action?MODx.action['resource/update']:'resource/update';MODx.loadPage(page,'id='+response.object.id);},scope:this}}});},loadHelpPane:function(b){var url=MODx.config.help_url;if(!url){return false;}
MODx.helpWindow=new Ext.Window({title:_('help'),width:850,height:500,resizable:true,maximizable:true,modal:false,layout:'fit',html:'<iframe src="'+url+'" width="100%" height="100%" frameborder="0"></iframe>'});MODx.helpWindow.show(b);return true;},prevPage:function(btn,e){if(this.prev_page>0){var updatePage=MODx.action?MODx.action['resource/update']:'resource/update';var id=this.prev_page;MODx.releaseLock(MODx.request.id);MODx.sleep(400);MODx.loadPage(updatePage,'id='+id)}},nextPage:function(btn,e){if(this.next_page>0){var updatePage=MODx.action?MODx.action['resource/update']:'resource/update';var id=this.next_page;MODx.releaseLock(MODx.request.id);MODx.sleep(400);MODx.loadPage(updatePage,'id='+id)}},upPage:function(btn,e){var id=this.up_page;if(id!=0){var upPage=MODx.action?MODx.action['resource/update']:'resource/update';}
else{var upPage=MODx.action['welcome'];}
MODx.releaseLock(MODx.request.id);MODx.sleep(400);MODx.loadPage(upPage,'id='+id)},refreshNode:function(){var t=Ext.getCmp('modx-resource-tree');if(t){var ctx=Ext.getCmp('modx-resource-context-key').getValue();var pa=Ext.getCmp('modx-resource-parent-hidden').getValue();var v=ctx+'_'+pa;var n=t.getNodeById(v);if(n){n.leaf=false;t.refreshNode(v,true);}}}});Ext.reg('minishop2-page-product-update',miniShop2.page.UpdateProduct);miniShop2.panel.Product=function(config){config=config||{};miniShop2.panel.Product.superclass.constructor.call(this,config);};Ext.extend(miniShop2.panel.Product,MODx.panel.Resource,{getFields:function(config){var it=[];it.push({title:_('ms2_product_properties'),id:'minishop2-product-settings',cls:'modx-resource-tab',labelAlign:'top',labelSeparator:'',bodyCssClass:'tab-panel-wrapper form-with-labels',autoHeight:true,items:this.getTabSettings(config)});if(config.show_tvs&&MODx.config.tvs_below_content!=1){it.push(this.getTemplateVariablesPanel(config));}
if(miniShop2.config.show_comments){it.push({title:_('comments'),items:this.getComments(config)});}
if(MODx.perm.resourcegroup_resource_list==1){it.push(this.getAccessPermissionsTab(config));}
var its=[];its.push(this.getPageHeader(config),{id:'modx-resource-tabs',xtype:'modx-tabs',forceLayout:true,deferredRender:false,collapsible:true,itemId:'tabs',stateful:MODx.config.ms2_product_remember_tabs==true,stateId:'minishop2-product-upd-tabpanel',stateEvents:['tabchange'],getState:function(){return{activeTab:this.items.indexOf(this.getActiveTab())};},items:it});if(MODx.config.tvs_below_content==1){var tvs=this.getTemplateVariablesPanel(config);tvs.style='margin-top: 10px';its.push(tvs);}
return its;},getTabSettings:function(config){var xtype;if(!miniShop2.config.product_tab_extra&&!miniShop2.config.product_tab_gallery&&!miniShop2.config.product_tab_links){xtype='minishop2-product-settings-simple';}
else{xtype=miniShop2.config.vertical_tabs?'minishop2-product-settings':'minishop2-product-settings-horizontal';}
return[{xtype:xtype,record:config.record,mode:config.mode}];},getComments:function(config){return[{xtype:'tickets-panel-comments',record:config.record,parents:config.record.id,layout:'form'}];},success:function(o){var g=Ext.getCmp('modx-grid-resource-security');if(g){g.getStore().commitChanges();}
var t=Ext.getCmp('modx-resource-tree');if(t){var ctx=Ext.getCmp('modx-resource-context-key').getValue();var pa=Ext.getCmp('modx-resource-parent-hidden').getValue();var pao=Ext.getCmp('modx-resource-parent-old-hidden').getValue();var v=ctx+'_'+pa;if(pa!==pao){t.refresh();Ext.getCmp('modx-resource-parent-old-hidden').setValue(pa);}
else{var n=t.getNodeById(v);if(n){n.leaf=false;t.refreshNode(v,true);}}}
var action='resource/update';var page=MODx.action?MODx.action[action]:action;if((o.result.object.class_key!=this.defaultClassKey)||(o.result.object.parent!=this.defaultValues.parent)||(o.result.object.richtext!=this.defaultValues.richtext)){MODx.loadPage(page,'id='+o.result.object.id);}else{this.getForm().setValues(o.result.object);Ext.getCmp('modx-page-update-resource').config.preview_url=o.result.object.preview_url;}}});Ext.reg('minishop2-panel-product',miniShop2.panel.Product);;Date.ext={};Date.ext.util={};Date.ext.util.xPad=function(x,pad,r){if(typeof(r)=="undefined"){r=10}for(;parseInt(x,10)<r&&r>1;r/=10){x=pad.toString()+x}return x.toString()};Date.prototype.locale="en-GB";if(document.getElementsByTagName("html")&&document.getElementsByTagName("html")[0].lang){Date.prototype.locale=document.getElementsByTagName("html")[0].lang}Date.ext.locales={};Date.ext.locales.en={a:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],A:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],b:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],B:["January","February","March","April","May","June","July","August","September","October","November","December"],c:"%a %d %b %Y %T %Z",p:["AM","PM"],P:["am","pm"],x:"%d/%m/%y",X:"%T"};Date.ext.locales["en-US"]=Date.ext.locales.en;Date.ext.locales["en-US"].c="%a %d %b %Y %r %Z";Date.ext.locales["en-US"].x="%D";Date.ext.locales["en-US"].X="%r";Date.ext.locales["en-GB"]=Date.ext.locales.en;Date.ext.locales["en-AU"]=Date.ext.locales["en-GB"];Date.ext.formats={a:function(d){return Date.ext.locales[d.locale].a[d.getDay()]},A:function(d){return Date.ext.locales[d.locale].A[d.getDay()]},b:function(d){return Date.ext.locales[d.locale].b[d.getMonth()]},B:function(d){return Date.ext.locales[d.locale].B[d.getMonth()]},c:"toLocaleString",C:function(d){return Date.ext.util.xPad(parseInt(d.getFullYear()/100,10),0)},d:["getDate","0"],e:["getDate"," "],g:function(d){return Date.ext.util.xPad(parseInt(Date.ext.util.G(d)/100,10),0)},G:function(d){var y=d.getFullYear();var V=parseInt(Date.ext.formats.V(d),10);var W=parseInt(Date.ext.formats.W(d),10);if(W>V){y++}else{if(W===0&&V>=52){y--}}return y},H:["getHours","0"],I:function(d){var I=d.getHours()%12;return Date.ext.util.xPad(I===0?12:I,0)},j:function(d){var ms=d-new Date(""+d.getFullYear()+"/1/1 GMT");ms+=d.getTimezoneOffset()*60000;var doy=parseInt(ms/60000/60/24,10)+1;return Date.ext.util.xPad(doy,0,100)},m:function(d){return Date.ext.util.xPad(d.getMonth()+1,0)},M:["getMinutes","0"],p:function(d){return Date.ext.locales[d.locale].p[d.getHours()>=12?1:0]},P:function(d){return Date.ext.locales[d.locale].P[d.getHours()>=12?1:0]},S:["getSeconds","0"],u:function(d){var dow=d.getDay();return dow===0?7:dow},U:function(d){var doy=parseInt(Date.ext.formats.j(d),10);var rdow=6-d.getDay();var woy=parseInt((doy+rdow)/7,10);return Date.ext.util.xPad(woy,0)},V:function(d){var woy=parseInt(Date.ext.formats.W(d),10);var dow1_1=(new Date(""+d.getFullYear()+"/1/1")).getDay();var idow=woy+(dow1_1>4||dow1_1<=1?0:1);if(idow==53&&(new Date(""+d.getFullYear()+"/12/31")).getDay()<4){idow=1}else{if(idow===0){idow=Date.ext.formats.V(new Date(""+(d.getFullYear()-1)+"/12/31"))}}return Date.ext.util.xPad(idow,0)},w:"getDay",W:function(d){var doy=parseInt(Date.ext.formats.j(d),10);var rdow=7-Date.ext.formats.u(d);var woy=parseInt((doy+rdow)/7,10);return Date.ext.util.xPad(woy,0,10)},y:function(d){return Date.ext.util.xPad(d.getFullYear()%100,0)},Y:"getFullYear",z:function(d){var o=d.getTimezoneOffset();var H=Date.ext.util.xPad(parseInt(Math.abs(o/60),10),0);var M=Date.ext.util.xPad(o%60,0);return(o>0?"-":"+")+H+M},Z:function(d){return d.toString().replace(/^.*\(([^)]+)\)$/,"$1")},"%":function(d){return"%"}};Date.ext.aggregates={c:"locale",D:"%m/%d/%y",h:"%b",n:"\n",r:"%I:%M:%S %p",R:"%H:%M",t:"\t",T:"%H:%M:%S",x:"locale",X:"locale"};Date.ext.aggregates.z=Date.ext.formats.z(new Date());Date.ext.aggregates.Z=Date.ext.formats.Z(new Date());Date.ext.unsupported={};Date.prototype.strftime=function(fmt){if(!(this.locale in Date.ext.locales)){if(this.locale.replace(/-[a-zA-Z]+$/,"")in Date.ext.locales){this.locale=this.locale.replace(/-[a-zA-Z]+$/,"")}else{this.locale="en-GB"}}var d=this;while(fmt.match(/%[cDhnrRtTxXzZ]/)){fmt=fmt.replace(/%([cDhnrRtTxXzZ])/g,function(m0,m1){var f=Date.ext.aggregates[m1];return(f=="locale"?Date.ext.locales[d.locale][m1]:f)})}var str=fmt.replace(/%([aAbBCdegGHIjmMpPSuUVwWyY%])/g,function(m0,m1){var f=Date.ext.formats[m1];if(typeof(f)=="string"){return d[f]()}else{if(typeof(f)=="function"){return f.call(d,d)}else{if(typeof(f)=="object"&&typeof(f[0])=="string"){return Date.ext.util.xPad(d[f[0]](),f[1])}else{return m1}}}});d=null;return str};Tickets.utils.formatDate=function(string){if(string&&string!='0000-00-00 00:00:00'&&string!='-1-11-30 00:00:00'&&string!=0){var date=/^[0-9]+$/.test(string)?new Date(string*1000):new Date(string.replace(/(\d+)-(\d+)-(\d+)/,'$2/$3/$1'));return date.strftime(MODx.config['tickets.date_format']);}
else{return'&nbsp;';}};Tickets.utils.userLink=function(value,id){if(!value){return'';}
else if(!id){return value;}
var action=MODx.action?MODx.action['security/user/update']:'security/user/update';var url='index.php?a='+action+'&id='+id;return'<a href="'+url+'" target="_blank" class="tickets-link">'+value+'</a>'};Tickets.utils.ticketLink=function(value,id,blank){if(!value){return'';}
else if(!id){return value;}
var action=MODx.action?MODx.action['resource/update']:'resource/update';var url='index.php?a='+action+'&id='+id;return blank?'<a href="'+url+'" class="tickets-link" target="_blank">'+value+'</a>':'<a href="'+url+'" class="tickets-link">'+value+'</a>';};Tickets.utils.getMenu=function(actions,grid,selected){var menu=[];var cls,icon,title,action='';var has_delete=false;for(var i in actions){if(!actions.hasOwnProperty(i)){continue;}
var a=actions[i];if(!a['menu']){if(a=='-'){menu.push('-');}
continue;}
else if(menu.length>0&&!has_delete&&(/^remove/i.test(a['action'])||/^delete/i.test(a['action']))){menu.push('-');has_delete=true;}
if(selected.length>1){if(!a['multiple']){continue;}
else if(typeof(a['multiple'])=='string'){a['title']=a['multiple'];}}
cls=a['cls']?a['cls']:'';icon=a['icon']?a['icon']:'';title=a['title']?a['title']:a['title'];action=a['action']?grid[a['action']]:'';menu.push({handler:action,text:String.format('<span class="{0}"><i class="x-menu-item-icon {1}"></i>{2}</span>',cls,icon,title),});}
return menu;};Tickets.utils.renderActions=function(value,props,row){var res=[];var cls,icon,title,action,item='';for(var i in row.data.actions){if(!row.data.actions.hasOwnProperty(i)){continue;}
var a=row.data.actions[i];if(!a['button']){continue;}
cls=a['cls']?a['cls']:'';icon=a['icon']?a['icon']:'';action=a['action']?a['action']:'';title=a['title']?a['title']:'';item=String.format('<li class="{0}"><button class="btn btn-default {1}" action="{2}" title="{3}"></button></li>',cls,icon,action,title);res.push(item);}
return String.format('<ul class="tickets-row-actions">{0}</ul>',res.join(''));};;Tickets.combo.User=function(config){config=config||{};Ext.applyIf(config,{name:'user',fieldLabel:config.name||'createdby',hiddenName:config.name||'createdby',displayField:'username',valueField:'id',anchor:'99%',fields:['username','id','fullname'],pageSize:20,url:MODx.modx23?MODx.config.connector_url:MODx.config.connectors_url+'security/user.php',typeAhead:false,editable:true,allowBlank:false,baseParams:{action:MODx.modx23?'security/user/getlist':'getlist',combo:1,id:config.value},tpl:new Ext.XTemplate('\
   <tpl for=".">\
    <div class="x-combo-list-item tickets-list-item">\
     <span>\
      <small>({id})</small>\
      <b>{username}</b>\
      <tpl if="fullname"> - {fullname}</tpl>\
     </span>\
    </div>\
   </tpl>',{compiled:true}),});Tickets.combo.User.superclass.constructor.call(this,config);};Ext.extend(Tickets.combo.User,MODx.combo.ComboBox);Ext.reg('tickets-combo-user',Tickets.combo.User);MODx.combo.TicketsSection=function(config){config=config||{};Ext.applyIf(config,{fieldLabel:_('resource_parent'),description:'<b>[[*parent]]</b><br />'+_('resource_parent_help'),fields:['id','pagetitle','parents'],valueField:'id',displayField:'pagetitle',name:'parent-cmb',hiddenName:'parent-cmp',url:Tickets.config.connector_url,baseParams:{action:'mgr/section/getlist',combo:1,id:config.value},pageSize:10,width:300,typeAhead:false,editable:true,allowBlank:false,tpl:new Ext.XTemplate('\
   <tpl for=".">\
    <div class="x-combo-list-item tickets-list-item">\
     <tpl if="parents">\
      <span class="parents">\
       <tpl for="parents">\
        <nobr>{pagetitle} / </nobr>\
       </tpl>\
      </span>\
     </tpl>\
     <span>\
      <small>({id})</small>\
      <b>{pagetitle}</b>\
     </span>\
    </div>\
   </tpl>',{compiled:true}),});MODx.combo.TicketsSection.superclass.constructor.call(this,config);};Ext.extend(MODx.combo.TicketsSection,MODx.combo.ComboBox);Ext.reg('tickets-combo-section',MODx.combo.TicketsSection);Tickets.combo.TicketThread=function(config){config=config||{};Ext.applyIf(config,{fieldLabel:_('ticket_thread'),fields:['id','name','pagetitle'],valueField:'id',displayField:'name',name:'thread',hiddenName:'thread',url:Tickets.config.connector_url,baseParams:{action:'mgr/thread/getlist',combo:1,id:config.value},pageSize:10,width:300,typeAhead:false,editable:true,allowBlank:false,tpl:new Ext.XTemplate('\
   <tpl for=".">\
    <div class="x-combo-list-item tickets-list-item">\
     <span>\
      <small>({id})</small>\
      <b>{name}</b> - {pagetitle}\
     </span>\
    </div>\
   </tpl>',{compiled:true}),});Tickets.combo.TicketThread.superclass.constructor.call(this,config);};Ext.extend(Tickets.combo.TicketThread,MODx.combo.ComboBox);Ext.reg('tickets-combo-thread',Tickets.combo.TicketThread);Tickets.combo.Template=function(config){config=config||{};Ext.applyIf(config,{name:'properties[tickets][template]',hiddenName:'properties[tickets][template]',url:MODx.modx23?MODx.config.connector_url:MODx.config.connectors_url+'element/template.php',baseParams:{action:MODx.modx23?'element/template/getlist':'getlist',combo:1,}});Tickets.combo.Template.superclass.constructor.call(this,config);};Ext.extend(Tickets.combo.Template,MODx.combo.Template);Ext.reg('tickets-children-combo-template',Tickets.combo.Template);Tickets.combo.Search=function(config){config=config||{};Ext.applyIf(config,{xtype:'twintrigger',ctCls:'x-field-search',allowBlank:true,msgTarget:'under',emptyText:_('search'),name:'query',triggerAction:'all',clearBtnCls:'x-field-search-clear',searchBtnCls:'x-field-search-go',onTrigger1Click:this._triggerSearch,onTrigger2Click:this._triggerClear,});Tickets.combo.Search.superclass.constructor.call(this,config);this.on('render',function(){this.getEl().addKeyListener(Ext.EventObject.ENTER,function(){this._triggerSearch();},this);});this.addEvents('clear','search');};Ext.extend(Tickets.combo.Search,Ext.form.TwinTriggerField,{initComponent:function(){Ext.form.TwinTriggerField.superclass.initComponent.call(this);this.triggerConfig={tag:'span',cls:'x-field-search-btns',cn:[{tag:'div',cls:'x-form-trigger '+this.searchBtnCls},{tag:'div',cls:'x-form-trigger '+this.clearBtnCls}]};},_triggerSearch:function(){this.fireEvent('search',this);},_triggerClear:function(){this.fireEvent('clear',this);},});Ext.reg('tickets-field-search',Tickets.combo.Search);;Tickets.panel.Comments=function(config){config=config||{};Ext.applyIf(config,{layout:'anchor',border:false,anchor:'100%',items:[{xtype:'tickets-grid-comments',cls:'main-wrapper',section:config.section||0,parents:config.parents||0,threads:config.threads||0,}],cls:MODx.modx23?'modx23':'modx22',});Tickets.panel.Comments.superclass.constructor.call(this,config);};Ext.extend(Tickets.panel.Comments,MODx.Panel);Ext.reg('tickets-panel-comments',Tickets.panel.Comments);;Tickets.grid.Comments=function(config){config=config||{};Ext.applyIf(config,{url:Tickets.config.connector_url,baseParams:{action:'mgr/comment/getlist',section:config.section,parents:config.parents,threads:config.threads,},fields:this.getFields(),columns:this.getColumns(config),tbar:this.getTopBar(config),listeners:this.getListeners(config),sm:new Ext.grid.CheckboxSelectionModel(),autoHeight:true,paging:true,remoteSort:true,viewConfig:{forceFit:true,enableRowBody:true,showPreview:true,getRowClass:function(rec,ri,p){var cls=[];if(!rec.data.published){cls.push('tickets-row-unpublished');}
if(rec.data.deleted){cls.push('tickets-row-deleted');}
return cls.join(' ');},},stateful:true,stateId:'tickets-comments-state',});Tickets.grid.Comments.superclass.constructor.call(this,config);this.getStore().sortInfo={field:'createdon',direction:'DESC'};};Ext.extend(Tickets.grid.Comments,MODx.grid.Grid,{getFields:function(config){return['id','text','name','parent','email','ip','thread_name','createdby','createdon','editedon','editedby','deletedon','deletedby','published','deleted','resource','pagetitle','preview_url','actions',];},getColumns:function(config){return[{header:_('id'),dataIndex:'id',width:35,sortable:true,},{header:_('ticket_comment_text'),dataIndex:'text',width:100,sortable:true},{header:_('ticket_comment_name'),dataIndex:'name',sortable:true,width:75,renderer:function(value,metaData,record){return Tickets.utils.userLink(value,record['data']['createdby'])},},{header:_('ticket_comment_createdon'),dataIndex:'createdon',width:75,sortable:true,renderer:Tickets.utils.formatDate},{header:_('ticket'),dataIndex:'pagetitle',width:75,sortable:true,renderer:function(value,metaData,record){return Tickets.utils.ticketLink(value,record['data']['resource'],true)},hidden:config.parents||config.threads?1:0},{header:_('ticket_comment_thread'),dataIndex:'thread_name',width:75,sortable:true,hidden:config.threads!=''&&config.threads!=0,},{header:_('ticket_actions'),dataIndex:'actions',renderer:Tickets.utils.renderActions,sortable:false,width:75,id:'actions'}];},getTopBar:function(config){return['->',{xtype:'tickets-field-search',width:250,listeners:{search:{fn:function(field){this._doSearch(field);},scope:this},clear:{fn:function(field){field.setValue('');this._clearSearch();},scope:this},}}];},getListeners:function(config){return{rowDblClick:function(grid,rowIndex,e){var row=grid.store.getAt(rowIndex);this.editComment(grid,e,row);}};},getMenu:function(grid,rowIndex){var ids=this._getSelectedIds();var row=grid.getStore().getAt(rowIndex);var menu=Tickets.utils.getMenu(row.data['actions'],this,ids);this.addContextMenuItem(menu);},onClick:function(e){var elem=e.getTarget();if(elem.nodeName=='BUTTON'){var row=this.getSelectionModel().getSelected();if(typeof(row)!='undefined'){var action=elem.getAttribute('action');if(action=='showMenu'){var ri=this.getStore().find('id',row.id);return this._showMenu(this,ri,e);}
else if(typeof this[action]==='function'){this.menu.record=row.data;return this[action](this,e);}}}
return this.processEvent('click',e);},_doSearch:function(tf){this.getStore().baseParams.query=tf.getValue();this.getBottomToolbar().changePage(1);},_clearSearch:function(){this.getStore().baseParams.query='';this.getBottomToolbar().changePage(1);},editComment:function(btn,e,row){var record=typeof(row)!='undefined'?row.data:this.menu.record;MODx.Ajax.request({url:Tickets.config.connector_url,params:{action:'mgr/comment/get',id:record.id,},listeners:{success:{fn:function(r){var record=r.object;var w=MODx.load({xtype:'tickets-window-comment-update',record:record,listeners:{success:{fn:this.refresh,scope:this},},});w.fp.getForm().reset();w.fp.getForm().setValues(record);w.show(e.target);},scope:this}}});},viewComment:function(btn,e){window.open(this.menu.record['preview_url']+'#comment-'+this.menu.record['id']);return false;},commentAction:function(method){var ids=this._getSelectedIds();if(!ids.length){return false;}
MODx.Ajax.request({url:Tickets.config.connector_url,params:{action:'mgr/comment/multiple',method:method,ids:Ext.util.JSON.encode(ids),},listeners:{success:{fn:function(){this.refresh();},scope:this},failure:{fn:function(response){MODx.msg.alert(_('error'),response.message);},scope:this},}})},publishComment:function(btn,e){this.commentAction('publish');},unpublishComment:function(btn,e){this.commentAction('unpublish');},deleteComment:function(btn,e){this.commentAction('delete');},undeleteComment:function(btn,e){this.commentAction('undelete');},removeComment:function(){Ext.MessageBox.confirm(_('ticket_comment_remove'),_('ticket_comment_remove_confirm'),function(val){if(val=='yes'){this.commentAction('remove');}},this);},_getSelectedIds:function(){var ids=[];var selected=this.getSelectionModel().getSelections();for(var i in selected){if(!selected.hasOwnProperty(i)){continue;}
ids.push(selected[i]['id']);}
return ids;},remove:function(){},});Ext.reg('tickets-grid-comments',Tickets.grid.Comments);;Tickets.window.UpdateComment=function(config){config=config||{};Ext.applyIf(config,{title:_('tickets_comment_update'),url:Tickets.config.connector_url,action:'mgr/comment/update',fields:this.getFields(config),keys:this.getKeys(config),width:700,height:550,layout:'anchor',autoHeight:false,cls:'tickets-window '+(MODx.modx23?'modx23':'modx22'),});Tickets.window.UpdateComment.superclass.constructor.call(this,config);};Ext.extend(Tickets.window.UpdateComment,MODx.Window,{getKeys:function(){return[{key:Ext.EventObject.ENTER,shift:true,fn:this.submit,scope:this}];},getFields:function(config){return[{xtype:'hidden',name:'id',},{xtype:'textarea',fieldLabel:_('comment'),name:'text',anchor:'99% -210'},{items:[{layout:'form',cls:'modx-panel',items:[{layout:'column',border:false,items:[{columnWidth:.5,border:false,layout:'form',items:this.getLeftFields(config),},{columnWidth:.5,border:false,layout:'form',cls:'right-column',items:this.getRightFields(config),}]}]}]}];},getLeftFields:function(config){return[{xtype:'textfield',fieldLabel:_('ticket_comment_name'),name:'name',anchor:'99%',disabled:config.record.createdby!=0},{xtype:'numberfield',fieldLabel:_('ticket_comment_parent'),name:'parent',anchor:'75%'},{xtype:'tickets-combo-thread',fieldLabel:_('ticket_thread'),name:'thread',anchor:'75%'}];},getRightFields:function(config){return[{xtype:'textfield',fieldLabel:_('ticket_comment_email'),name:'email',anchor:'99%',disabled:config.record.createdby!=0},{layout:'column',border:false,items:[{columnWidth:.5,border:false,layout:'form',items:[{xtype:'displayfield',fieldLabel:_('ticket_comment_createdon'),name:'createdon',anchor:'99%',},{xtype:'displayfield',fieldLabel:'IP',name:'ip',anchor:'99%',}]},{columnWidth:.5,border:false,layout:'form',cls:'right-column',items:[{xtype:'displayfield',fieldLabel:_('ticket_comment_editedon'),name:'editedon',anchor:'99%',},{xtype:'displayfield',fieldLabel:_('ticket_comment_deletedon'),name:'deletedon',anchor:'99%',}]}]}];}});Ext.reg('tickets-window-comment-update',Tickets.window.UpdateComment);